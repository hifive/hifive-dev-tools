<?xml version="1.0" encoding="UTF-8"?>
<project name="h5devtool-builder" basedir="." default="build">
	<property name="WebContent" value="WebContent" />
	<property name="srcDir" value="${WebContent}/src" />
	<property name="buildDir" value="${WebContent}/build" />
	<property name="buildHeadDir" value="${WebContent}/build" />
	<property name="config" value="config" />

	<property name="lib.project.dir" value="./lib" />

	<path id="base.path">
		<fileset dir="${lib.project.dir}" includes="**/*.jar" />
	</path>

	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpathref="base.path" />

	<target name="clean">
		<delete>
			<fileset dir="${buildDir}/">
				<include name="**" />
			</fileset>
		</delete>
	</target>

	<target name="getVersion" unless="versionNumber">
		<input message="バージョン番号を入力してください。(ex. 1.0.1)" addproperty="versionNumber" />
		<condition property="isCorrectNumber">
			<matches pattern="[0-9]+\.[0-9]+\.[0-9]+" string="${versionNumber}" />
		</condition>
		<fail unless="isCorrectNumber" message="正しいバージョン番号を入力してください。" />
	</target>

	<target name="getGitHash">
		<property name="git.dir" value="../.git/logs/HEAD" />
		<available file="${git.dir}" property="git.exists" />
		<fail unless="git.exists" message="${git.dir}が存在しません" />
		<loadfile srcfile="${git.dir}" property="gitCommitId">
			<filterchain>
				<tailfilter lines="1" />
				<striplinebreaks />
				<replaceregex pattern="[A-z0-9]+ ([A-z0-9]+) .*" replace="\1" />
			</filterchain>
		</loadfile>
		<echo message="gitCommitId: ${gitCommitId}" />
	</target>

	<target name="build" depends="clean,getVersion,getGitHash">
		<!-- ClosureCompilerを使ってmin版の作成。コンパイル後にヘッダ追記するので、build/tmp/フォルダにいったん出力する -->
		<jscomp compilationLevel="simple" debug="false" output="${buildDir}/tmp/h5.devtool.min.js">
			<sources dir="${srcDir}">
				<file name="h5.devtool.js" />
			</sources>
		</jscomp>
		<!-- min版のヘッダ挿入 -->
		<!-- ヘッダにversion, gitCommitIdのセット -->
		<copy file="${config}/min-build-header.txt" todir="${buildDir}/tmp" />
		<replace file="${buildDir}/tmp/min-build-header.txt">
			<replacefilter token="{version}" value="${versionNumber}" />
			<replacefilter token="{gitCommitId}" value="${gitCommitId}" />
		</replace>
		<!-- ヘッダとソースを結合 -->
		<concat destfile="${buildDir}/h5.devtool.min.js">
			<filelist dir="${buildDir}/tmp" files="min-build-header.txt,h5.devtool.min.js" />
		</concat>
		<!-- tmpフォルダの削除 -->
		<delete dir="${buildDir}/tmp" />

		<copy file="${srcDir}/h5devtool.html" todir="${buildDir}" />
		<copy file="${srcDir}/h5.devtool.js" todir="${buildDir}" />

		<property name="outputDir" location="${buildDir}" />
		<echo message="ビルドしたファイルを${outputDir}に出力しました。" />
	</target>

	<target name="setHeadVersion">
		<property name="versionNumber" value="0.0.0" />
	</target>

	<target name="build-head" depends="setHeadVersion, build">

	</target>
</project>